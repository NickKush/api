API комнат
==========
- [**Основное**](#Основное)
    - [`POST` `P` `/api/room` Данные комнаты](#Данные-комнаты)
    - [`POST` `A` `/api/room/create` Создать комнату](#Создать-комнату)
    - [`POST` `P` `/api/room/my` Список комнат пользователя](#Список-комнат-пользователя)
    - [`POST` `A` `/api/room/preview` Изменить превью комнаты](#Изменить-превью-комнаты)
    - [`POST` `A` `/api/room/settings` Настройки комнаты](#Настройки-комнаты)
- [**Видео**](#Видео)
    - [`POST` `P/A` `/api/room/getCurrentVideo` Текущая трансляция комнаты](#Текущая-трансляция-комнаты)
    - [`POST` `A` `/api/room/periscopeRandom` Ссылка на случайный стрим с перископа](#Ссылка-на-случайный-стрим-с-перископа)
    - [`POST` `A` `/api/room/setCurrentVideo` Изменить текущую трансляцию комнаты](#Изменить-текущую-трансляцию-комнаты)
- [**Плейлист**](#Плейлист)
    - [`POST` `P/A` `/api/room/playlist` Плейлист комнаты](#Плейлист-комнаты)
    - [`POST` `P/A` `/api/room/playlist/history` История воспроизведения комнаты](#История-воспроизведения-комнаты)
    - [`POST` `A` `/api/room/playlist/set` Изменить плейлист комнаты](#Изменить-плейлист-комнаты)
- [**Пользователи**](#Пользователи)
    - [`POST` `P` `/api/room/user/admin` Статус администратора комнаты](#Статус-администратора-комнаты)
    - [`POST` `A` `/api/room/user/list` Список имеющих доступ в комнату](#Список-имеющих-доступ-в-комнату)
    - [`POST` `A` `/api/room/user/remove` Лишить пользователя доступа в комнату](#Лишить-пользователя-доступа-в-комнату)
    - [`POST` `A` `/api/room/user/set` Изменить права доступа пользователя в комнату](#Изменить-права-доступа-пользователя-в-комнату)
- [**Инвайты**](#Инвайты)
    - [`POST` `A` `/api/room/invite` Запросить доступ в комнату](#Запросить-доступ-в-комнату)
    - [`POST` `A` `/api/room/invite/accept` Принять запрос](#Принять-запрос)
    - [`POST` `A` `/api/room/invite/blacklist` Переместить запрос в чёрный список](#Переместить-запрос-в-чёрный-список)
    - [`POST` `A` `/api/room/invite/list` Список запросов](#Список-запросов)
    - [`POST` `A` `/api/room/invite/reject` Отклонить запрос](#Отклонить-запрос)
    - [`POST` `A` `/api/room/invite/status` Статус запроса](#Статус-запроса)

#### [Уведомления](#Уведомления-1)
- [`roomModify` Данные комнаты изменены](#Данные-комнаты-изменены)
- [`roomVideo` Новая трансляция в комнате](#Новая-трансляция-в-комнате)
- [`roomUserRemoved` Пользователь лишён доступа в комнату](#Пользователь-лишён-доступа-в-комнату)
- [`roomUserSet` Изменены права доступа пользователя в комнату](#Изменены-права-доступа-пользователя-в-комнату)

---


## Основное

#### Данные комнаты
##### [`POST` `P` `/api/room`](http://funstream.tv/api/room)
**запрос**
```ts
{
    roomId: number; // Идентификатор комнаты
}
```
**ответ**
```ts
{
    id: number; // Идентификатор комнаты
    name: string; // Имя комнаты
    owner: Object; // Создатель комнаты, объект из ответа /api/user
    category: Object; // Категория комнаты, объект из ответа /api/category
    mode: string; // Режим комнаты, [public | private]
    hidden: boolean; // Флаг скрытия комнаты в фильтре
    rating: number; // Рейтинг комнаты
    image: string; // Полная ссылка на превью картинку комнаты
    thumbnail: string; // Полная ссылка на тамб картинку комнаты, совпадает с превью
    slug: string; // Имя комнаты в ссылке, /room/<slug>
    available: boolean; // Доступность комнаты текущему пользователю
}
```
*[`/api/user`](common.md#Данные-пользователя), [`/api/category`](common.md#Категория-контента)*  
*Вернёт ошибку если передан неверный идентификатор.*


#### Создать комнату
##### [`POST` `A` `/api/room/create`](http://funstream.tv/api/room/create)
**запрос**
```ts
{
    name: string; // Имя комнаты
    categoryId: number; // Идентификатор категории
    mode: string; // Режим комнаты, [public | private], по умолчанию public
    hidden: boolean; // Флаг скрытия комнаты в фильтре, по умолчанию false,
    slug: string; // Имя комнаты в ссылке, /room/<slug>
}
```
**ответ**
```ts
{
    // Данные комнаты, объект из ответа /api/room
}
```
*[`/api/room`](#Данные-комнаты)*  
*Вернёт ошибкку если у пользователя уже создано 3 комнаты, передан неверный идентификатор категории,
неверный режим или выбранный slug уже используется.*


#### Список комнат пользователя
##### [`POST` `A` `/api/room/my`](http://funstream.tv/api/room/my)
**запрос**
```ts
{}
```
**ответ**
```ts
[
    {
        room: Object; // Данные комнаты, объект из ответа /api/room
        type: string; // Тип прав доступа в комнату, [user | admin]
    },
    ...
]
```
*[`/api/room`](#Данные-комнаты)*  
*Список комнат, доступ в которые имеет пользователь или является в них администратором.*


#### Изменить превью комнаты
##### [`POST` `A` `/api/room/preview`](http://funstream.tv/api/room/preview)
**запрос**
```ts
{
    roomId: number; // Идентификатор комнаты
}
```
**ответ**
```ts
{}
```
*Принимает одиночный файл, Content-Type: multipart/form-data.*  
*Вернёт ошибку если пользователь не имеет прав администратора комнаты, файл не передан,
формат файла не png, размер картинки не 534х300px.*


#### Настройки комнаты
##### [`POST` `A` `/api/room/settings`](http://funstream.tv/api/room/settings)
**запрос**
```ts
{
    roomId: number; // Идентификатор комнаты
    ... // Поля из запроса /api/room/create
}
```
**ответ**
```ts
{
    // Данные комнаты, объект из ответа /api/room
}
```
*[`/api/room/create`](#Создать-комнату), [`/api/room`](#Данные-комнаты)*  
*Вернёт ошибкку если пользователь не имеет прав администратора комнаты,
передан неверный идентификатор комнаты, неверный идентификатор категории, неверный режим или выбранный slug уже используется.*


## Видео


#### Текущая трансляция комнаты
##### [`POST` `P/A` `/api/room/getCurrentVideo`](http://funstream.tv/api/room/getCurrentVideo)
**запрос**
```ts
{
    roomId: number; // Идентификатор комнаты
}
```
**ответ**
```ts
{
    roomId: number; // Идентификатор комнаты
    url: string; // Ссылка на трансляцию
    playlistPosition: number; // Позиция трансляции в плейлисте, от 0
    code: { // HTML код плеера трансляции
        started: string; // С автозапуском
        paused: string; // Без автозапуска
    }
}
```
*Не может быть использован в [/api/bulk](common.md#Пакетный-запрос) запросе.*  
*Вернёт ошибку если комната приватная и текущий пользователь не имеет в неё доступа.*


#### Ссылка на случайный стрим с перископа
##### [`POST` `A` `/api/room/periscopeRandom`](http://funstream.tv/api/room/periscopeRandom)
**запрос**
```ts
{}
```
**ответ**
```ts
{
    url: string; // Ссылка на онлайн стрим перископа
}
```
*Использует запрос на https://www.periscope.tv/couchmode, может долго выдавать одну и ту же ссылку.*


#### Изменить текущую трансляцию комнаты
##### [`POST` `A` `/api/room/setCurrentVideo`](http://funstream.tv/api/room/setCurrentVideo)
**запрос**
```ts
{
    roomId: number; // Идентификатор комнаты
    position: number; // Позиция трансляции в плейлисте комнаты, от 0
}
```
**ответ**
```ts
{}
```
*Не может быть использован в [/api/bulk](common.md#Пакетный-запрос) запросе.*  
*Если значение `position` больше чем размер плейлиста, то запустит первую трансляцию в списке.*  
*Вернёт ошибку если пользователь не имеет прав администратора комнаты.*


## Плейлист

#### Плейлист комнаты
##### [`POST` `P/A` `/api/room/playlist`](http://funstream.tv/api/room/playlist)
**запрос**
```ts
{
    roomId: number; // Идентификатор комнаты
}
```
**ответ**
```ts
[
    {
      id: number; // Идентификатор трансляции в плейлисте
      position: number; // Позиция в плейлисте, от 0
      url: string; // Ссылка на трансляцию
      start: unixtime; // Время начала воспроизведения
      main: boolean; // Флаг основной трансляции
      persistent: boolean; // Флаг постоянной трансляции
    },
    ...
]
```
*Позицию воспринимать как ключ для сортировки, значения могут идти с разным интервалом.*  
*Вернёт ошибку если комната приватная и текущий пользователь не имеет в неё доступа.*


#### История воспроизведения комнаты
##### [`POST` `P/A` `/api/room/playlist/history`](http://funstream.tv/api/room/playlist/history)
**запрос**
```ts
{
    roomId: number; // Идентификатор комнаты
}
```
**ответ**
```ts
[
    {
        url: string; // Ссылка на трансляцию
        start: unixtime; // Время начала воспроизведения
        end: unixtime; // Время окончания воспроизведения
    },
    ...
]
```
*Вернёт ошибку если комната приватная и текущий пользователь не имеет в неё доступа.*


#### Изменить плейлист комнаты
##### [`POST` `A` `/api/room/playlist/set`](http://funstream.tv/api/room/playlist/set)
**запрос**
```ts
{
    roomId: number; // Идентификатор комнаты
    playlist: [ // Новый плейлист
        {
            position: number; // Позиция в плейлисте
            url: string; // Ссылка на трансляцию
            start: unixtime; // Время начала воспроизведения
            main: boolean; // Флаг основного трансляции
            persistent: boolean; // Флаг постоянной трансляции
        },
        ...
    ]
}
```
**ответ**
```ts
{}
```
*Вернёт ошибку если указан неверный идентификатор комнаты,
текущий пользователь не имеет прав администратора указаннойкомнаты,
для любого элемента плейлиста не указано любое из полей, указано более одной основной трансляции.*


## Пользователи

#### Статус администратора комнаты
##### [`POST` `P` `/api/room/user/admin`](http://funstream.tv/api/room/user/admin)
**запрос**
```ts
{
    roomId: number; // Идентификатор комнаты
}
```
**ответ**
```ts
{
    admin: boolean; // Статус администратора комнаты
}
```
*Вернёт ошибку если указан неверный идентификатор комнаты.*


#### Список имеющих доступ в комнату
##### [`POST` `A` `/api/room/user/list`](http://funstream.tv/api/room/user/list)
**запрос**
```ts
{
    roomId: number; // Идентификатор комнаты
}
```
**ответ**
```ts
[
    {
        type: string; // Тип прав доступа в комнату, [user | admin]
        user: Object; // Данные пользователя, объект из ответа /api/user
    },
    ...
]
```
*[`/api/user`](common.md#Данные-пользователя)*  
*Вернёт ошибку если указан неверный идентификатор комнаты или текущий пользователь не имеет прав администратора комнаты.*


#### Лишить пользователя доступа в комнату
##### [`POST` `A` `/api/room/user/remove`](http://funstream.tv/api/room/user/remove)
**запрос**
```ts
{
    roomId: number; // Идентификатор комнаты
    userId: number; // Идентификатор пользователя
}
```
**ответ**
```ts
{}
```
*Вернёт ошибку если указан неверный идентификатор комнаты,
указанный пользователь является создателем комнаты или текущий пользователь не имеет прав администратора комнаты.*


#### Изменить права доступа пользователя в комнату
##### [`POST` `A` `/api/room/user/set`](http://funstream.tv/api/room/user/set)
**запрос**
```ts
{
    roomId: number; // Идентификатор комнаты
    userId: number; // Идентификатор пользователя
    type: string; // Тип прав доступа в комнату, [user | admin]
}
```
**ответ**
```ts
{}
```
*Значение поля `type` указывает на новые права пользователя.
Т.е. если было `admin`, а стало `user`, то это лишение прав администратора комнаты.*  
*Вернёт ошибку если указан неверный идентификатор комнаты или текущий пользователь не имеет прав администратора комнаты.*


## Инвайты

#### Запросить доступ в комнату
##### [`POST` `A` `/api/room/invite`](http://funstream.tv/api/room/invite)
**запрос**
```ts
{
    roomId: number; // Идентификатор комнаты
}
```
**ответ**
```ts
{}
```
*Вернёт ошибку если указан неверный идентификатор комнаты,
уже имеется запрос от пользователя или у пользователя есть доступ в эту комнату.*


#### Принять запрос
##### [`POST` `A` `/api/room/invite/accept`](http://funstream.tv/api/room/invite/accept)
**запрос**
```ts
{
    inviteId: number; // Идентификатор запроса
}
```
**ответ**
```ts
{}
```
*Вернёт ошибку если указан неверный идентификатор запроса или пользователь не имеет прав администратора комнаты.*


#### Переместить запрос в чёрный список
##### [`POST` `A` `/api/room/invite/blacklist`](http://funstream.tv/api/room/invite/blacklist)
**запрос**
```ts
{
    inviteId: number; // Идентификатор запроса
}
```
**ответ**
```ts
{}
```
*Вернёт ошибку если указан неверный идентификатор запроса или пользователь не имеет прав администратора комнаты.*


#### Список запросов
##### [`POST` `A` `/api/room/invite/list`](http://funstream.tv/api/room/invite/list)
**запрос**
```ts
{
    roomId: number; // Идентификатор комнаты
}
```
**ответ**
```ts
[
    Object, // Данные запроса, объект из ответа /api/room/invite/status
    ...
]
```
*[`/api/room/invite/status`](#Статус-запроса)*  
*Вернёт ошибку если пользователь не имеет прав администратора комнаты.*


#### Отклонить запрос
##### [`POST` `A` `/api/room/invite/reject`](http://funstream.tv/api/room/invite/reject)
**запрос**
```ts
{
    inviteId: number; // Идентификатор запроса
}
```
**ответ**
```ts
{}
```
*Вернёт ошибку если указан неверный идентификатор запроса или пользователь не имеет прав администратора комнаты.*


#### Статус запроса
##### [`POST` `A` `/api/room/invite/status`](http://funstream.tv/api/room/invite/status)
**запрос**
```ts
{
    roomId: number; // Идентификатор комнаты
}
```
**ответ**
```ts
{
    id: number; // Идентификатор запроса
    roomId: number; // Идентификатор комнаты
    blacklisted: boolean; // Статус наличия запроса в чёрном списке
    requested: unixtime; // Дата запроса
    user: Object; // Данные пользователя, объект из ответа /api/user
}
```
*[`/api/user`](common.md#Данные-пользователя)*  
*Вернёт ошибку если не найден запрос доступа в указанную комнату.*


# [Уведомления](notification.md)

#### Данные комнаты изменены
##### `roomModify`
```ts
{
    roomId: number; // Идентификатор комнаты
    data: Object; // Обновлённые данные комнаты, объект из ответа /api/room
}
```
*[`/api/room`](#Данные-комнаты)*  
*Приходит всем подсоединившимся к каналу комнаты при изменении основных данных комнаты.*


#### Новая трансляция в комнате
##### `roomVideo`
```ts
{
    // Данные трансляции, объект из ответа /api/room/getCurrentVideo
}
```
*[`/api/room/getCurrentVideo`](#Текущая-трансляция-комнаты)*  
*Приходит всем подсоединившимся к каналу комнаты при начале новой трансляции.*


#### Пользователь лишён доступа в комнату
##### `roomUserRemoved`
```ts
{
    roomId: number; // Идентификатор комнаты
    userId: number; // Идентификатор пользователя
}
```
*Приходит пользователю которого лишили доступа в комнату.*


#### Изменены права доступа пользователя в комнату
##### `roomUserSet`
```ts
{
    roomId: number; // Идентификатор комнаты
    userId: number; // Идентификатор пользователя
    type: number; // Тип прав полученных пользователем, см поле type в ответе запроса /api/room/user/set
}
```
*[`/api/room/user/set`](#Изменить-права-доступа-пользователя-в-комнату)*  
*Приходит пользователю, права доступа в комнату которого были изменены.*
