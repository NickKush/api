Работа с [OAuth](http://oauth.net/)
===================================

Термины
------------------
- **сервер** - веб-сервер [funstream.tv](http://funstream.tv/)
- **сайт** - сайт [funstream.tv](http://funstream.tv/)
- **приложение** - веб-сервер приложения, либо приложение в телефоне
- **пользователь** - зарегистрированный пользователь на [funstream.tv](http://funstream.tv/)
- **браузер** - браузер пользователя


Последовательность действий
------------------
1. Приложение регистрируется на сайте из под аккаунта владельца по ссылке [funstream.tv/oauth/app](http://funstream.tv/oauth/app), одно приложение на аккаунт. С этой страницы берётся код приложения.
2. По умолчанию приложение не имеет доступа к дополнительным возоможностям(см. ниже) и для их активации нужно подтверждение приложения администрацией. При любых изменениях параметров приложения доступ к дополнительным возможностям сбрасывает и требует повторого подтверждения.
3. Приложение запрашивает код [`/api/oauth/request`](#Запросить-код), передавая ключ приложения.
4. Приложение передает код в браузер, предлагая пользователю перейти по ссылке ```http://funstream.tv/oauth/<code>```. Если у приложения указана обратная ссылка, то по ссылке для пользователя можно указать дополнительные GET параметры, с которыми пользователь будет отправлен на обратную ссылку, например ```http://funstream.tv/oauth/<code>?param1=value1&param2=value2```
5. Пользователь переходит по ссылке (открывается в новом окне, `target="_blank"`).
6. Пользователь подтверждает код для приложения и закрывает окно.
7. Пользователь жмет 'Продолжить' в приложении. Если у приложения указана обратная ссылка, то его отправляет на эту ссылку(см выше про GET параметры).
8. Приложение получает токен используя [`/api/oauth/exchange`](#Получить-токен-по-коду).
9. Приложение вызывает API Funstream.tv, используя полученый токен.


В случае недобросовестного использования возможностей, предосталвяемых OAuth, администрация может удалить приложение и все используемые им токены перестанут приниматься.

##### Дополнительные возможности для приложения
- возможность писать в чат от имени пользователя


OAuth API
------------------
- [`POST` `A` `/api/oauth/app` Получить данные приложения](#Получить-данные-приложения)
- [`POST` `A` `/api/oauth/app/set` Сохранить данные приложения](#Сохранить-данные-приложения)
- [`POST` `P` `/api/oauth/check` Проверка статуса кода](#Проверка-статуса-кода)
- [`POST` `P` `/api/oauth/exchange` Получить токен по коду](#Получить-токен-по-коду)
- [`POST` `A` `/api/oauth/grant` Предоставить доступ по коду](#Предоставить-доступ-по-коду)
- [`POST` `A` `/api/oauth/list` Получить список приложений имеющих доступ](#Получить-список-приложений-имеющих-доступ)
- [`POST` `A` `/api/oauth/reject` Отменить доступ приложения](#Отменить-доступ-приложения)
- [`POST` `P` `/api/oauth/request` Запросить код](#Запросить-код)


#### Получить данные приложения
##### [`POST` `A` `/api/oauth/app`](http://funstream.tv/api/oauth/app)
**запрос**
```ts
{}
```
**ответ**
```ts
{
    name: string; // Имя приложения
    description: string; // Описание приложения
    key: string; // Ключ приложения
    approved: boolean; // Доступ к дополнительным возможностям
    redirect: string; // Обратная ссылка
}
```
*Вернёт ошибку если пользователь не залогинен или передан неверный токен.*


#### Сохранить данные приложения
##### [`POST` `A` `/api/oauth/app/set`](http://funstream.tv/api/oauth/app/set)
**запрос**
```ts
{
    name: string; // Имя приложения
    description: string; // Описание приложения
}
```
**ответ**
```ts
{}
```
*Вернёт ошибку если не передано имя или описание, пользователь не залогинен или передан неверный токен.*


#### Проверка статуса кода
##### [`POST` `P` `/api/oauth/check`](http://funstream.tv/api/oauth/check)
**запрос**
```ts
{
    code: string; // Код доступа OAuth
}
```
**ответ**
```ts
{
    id: number; // Идентификатор кода доступа
    app: Object; // Данные приложения, объект из ответа /api/oauth/app с пустым ключом
}
```
*Вернёт ошибку если переданный код не существует, уже подтверждён или приложение не существует.*


#### Получить токен по коду
##### [`POST` `P` `/api/oauth/exchange`](http://funstream.tv/api/oauth/exchange)
**запрос**
```ts
{
    code: string; // Код доступа OAuth
}
```
**ответ**
```ts
{
    token: string; // Токен доступа API
    user: Object; // Данные пользователя, объект из ответа /api/user/current
}
```
*Вернёт ошибку если переданный код не существует, не подтвержден пользователем или приложение не существует.*


#### Предоставить доступ по коду
##### [`POST` `A` `/api/oauth/grant`](http://funstream.tv/api/oauth/grant)
**запрос**
```ts
{
    code: string; // Код доступа OAuth
}
```
**ответ**
```ts
[]
```
*Вернёт ошибку если переданный код не существует, уже подтвержден, приложение не существует,
пользователь не залогинен или передан неверный токен.*


#### Получить список приложений имеющих доступ
##### [`POST` `A` `/api/oauth/list`](http://funstream.tv/api/oauth/list)
**запрос**
```ts
{}
```
**ответ**
```ts
[
    Object, // Данные приложения, объект из ответа /api/oauth/app с пустым ключом
    ...
]
```
*Пока не реализовано*  
*Вернёт список приложений, имеющих доступ к тем или иным возможностям пользователя*  
*Вернёт ошибку если пользователь не залогинен или передан неверный токен.*  
*Вернёт ошибку если переданный код не существует, уже подтвержден, пользователь не залогинен или передан неверный токен.*


#### Отменить доступ приложения
##### [`POST` `A` `/api/oauth/reject`](http://funstream.tv/api/oauth/reject)
**запрос**
```ts
{
    id: number; // Идентификатор приложения
}
```
**ответ**
```ts
{}
```
*Пока не реализовано*  
*Вернёт ошибку если передан неверный идентификатор приложения, пользователь не залогинен или передан неверный токен.*


#### Запросить код
##### [`POST` `P` `/api/oauth/request`](http://funstream.tv/api/oauth/request)
**запрос**
```ts
{
    key: string; // Ключ приложения, см. на странице редактирования данных приложения
}
```
**ответ**
```ts
{
    code: string; // Код доступа OAuth
}
```
*Вернёт ошибку если передан неверный ключ.*
