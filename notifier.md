Уведомления
===========
1. [**Событие уведомления**](#Событие-уведомления)
2. [**Типы уведомлений**](#Типы-уведомлений)
    - [**Модерация в чате**](#Модерация-в-чате)
        - [`chatBan` Бан в чате](#Бан-в-чате)
        - [`chatBanAttempt` Отметка о нарушении в чате](#Отметка-о-нарушении-в-чате)
        - [`chatBanUndo` Отмена бана в чате](#Отмена-бана-в-чате)
    - [**Донат в чате**](#Донат-в-чате)
        - [`chatChannelDonateLevel` Изменение донат уровня канала чата](#Изменение-донат-уровня-канала-чата)
    - [**Сторонние сервисы в чате**](#Сторонние-сервисы-в-чате)
        - [`chatThirdpartySendMessageError` Ошибка отправки сообщения в чат сервис](#Ошибка-отправки-сообщения-в-чат-сервис)
    - [**Комнаты**](#Комнаты)
        - [`roomModify` Данные комнаты изменены](#Данные-комнаты-изменены)
        - [`roomVideo` Новая трансляция в комнате](#Новая-трансляция-в-комнате)
        - [`roomUserRemoved` Пользователь лишён доступа в комнату](#Пользователь-лишён-доступа-в-комнату)
        - [`roomUserSet` Изменены права доступа пользователя в комнату](#Изменены-права-доступа-пользователя-в-комнату)
    - [**Сторонние сервисы**](#Сторонние-сервисы)
        - [`thirdpartyLogin` Логин через сторонние сервисы](#Логин-через-сторонние-сервисы)
        - [`thirdpartyRegister` Регистрация через сторонние сервисы](#Регистрация-через-сторонние-сервисы)


Событие уведомления
-------------------
Для уведомлений пользователя о всяческом используется событие вебсокетов [чата](chat.md#Протокол-взаимодействия) `/notifier/message` следующего формата
##### `WS` `P` `/notifier/message`
```ts
{
    userId: number; // Идентификатор пользователя, 0 по умолчанию
    sid: string; // Идентификатор сессии вебсокета, пустая строка по умолчания
    channel: string; // Идентификатор канала, пустая строка по умолчания
    type: string; // Тип события
    data: Object; // Данные события, см. описание конкретного события ниже
}
```
События могут слаться точечно залогиненному пользователю(во все открытые сессии), конкретному соединению по `sid`, сессиям в конкретном канале чата или всем подсоединённым сессиям.
Формат поля `data` произвольный и зависит от конкретного события. Далее для событий указаны тип и содержимое поля `data`.


Типы уведомлений
----------------


### Модерация в чате

#### Бан в чате
##### `chatBan`
```ts
{
    // Данные бана, ответ /api/moderation/check
}
```
*[/api/moderation/check](admin.md#Проверить-забанен-ли-пользователь)*
*Приходит при получении бана в чате.*


#### Отметка о нарушении в чате
##### `chatBanAttempt`
```ts
{
    messageId: number; // Идентификатор сообщения
    channel: string; // Идентификатор канала
}
```
*Приходит когда кто-то проголосовал за бан этого сообщения.*


#### Отмена бана в чате
##### `chatBanUndo`
```ts
{}
```
*Приходит при отмене бана текущего пользователя.*


### Донат в чате

#### Изменение донат уровня канала чата
##### `chatChannelDonateLevel`
```ts
{
    channel: string; // Идентификатор канала
    level: number; // Новый уровень
    amount: number; // Полная сумма доната
    topDonator: string; // Имя топ донатера(который внёс >= 90% суммы текущего доната за рассматриваемый период)
}
```
*Приходит при изменении уровня по суммарному донату(без прямых переводов и антидоната) за некоторый период(например 1 уровень - 300 пекоинов, 2 - 600 и т.д.). Только для каналов чата стримов. Используется для выдачи пользователям в этом канале бонусов(например смайлы соответствующего уровня).*


### Сторонние сервисы в чате

#### Ошибка отправки сообщения в чат сервис
##### `chatThirdpartySendMessageError`
```ts
{
    message: string; // Текст ошибки
}
```
*Приходит при ошибке отправки сообщения в сторонние сервисы: twitch, goodgame.*


### Комнаты

#### Данные комнаты изменены
##### `roomModify`
```ts
{
    roomId: number; // Идентификатор комнаты
    data: Object; // Обновлённые данные комнаты, объект из ответа /api/room
}
```
*[`/api/room`](room.md#Данные-комнаты)*
*Приходит всем подсоединившимся к каналу комнаты при изменении основных данных комнаты.*


#### Новая трансляция в комнате
##### `roomVideo`
```ts
{
    // Данные трансляции, объект из ответа /api/room/getCurrentVideo
}
```
*[`/api/room/getCurrentVideo`](room.md#Текущая-трансляция-комнаты)*
*Приходит всем подсоединившимся к каналу комнаты при начале новой трансляции.*


#### Пользователь лишён доступа в комнату
##### `roomUserRemoved`
```ts
{
    roomId: number; // Идентификатор комнаты
    userId: number; // Идентификатор пользователя
}
```
*Приходит пользователю которого лишили доступа в комнату.*


#### Изменены права доступа пользователя в комнату
##### `roomUserSet`
```ts
{
    roomId: number; // Идентификатор комнаты
    userId: number; // Идентификатор пользователя
    type: number; // Тип прав полученных пользователем, см поле type в ответе запроса /api/room/user/set
}
```
*[`/api/room/user/set`](room.md#Изменить-права-доступа-пользователя-в-комнату)*
*Приходит пользователю, права доступа в комнату которого были изменены.*


### Сторонние сервисы

#### Логин через сторонние сервисы
##### `thirdpartyLogin`
```ts
{
    // Данные логина, ответ /api/user/current
}
```
*[`/api/user/current`](common.md#Данные-текущего-пользователя)*
*Приходит при успешной авторизации через сторонний сервис.*


#### Регистрация через сторонние сервисы
##### `thirdpartyRegister`
```ts
{
    name: string; // Предлагаемое имя пользователя на основе данных стороннего сервиса
    token: string; // Токен для завершения регистрации
}
```
*Приходит при успешной авторизации через сторонний сервис если нет пользователя к которому привязан этот сервис.*
